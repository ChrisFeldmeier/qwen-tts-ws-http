<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qwen TTS Streaming Test</title>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #e4e4e4;
        }
        h1 { text-align: center; color: #00d4ff; margin-bottom: 10px; }
        h2 { color: #00d4ff; margin: 0 0 16px 0; font-size: 18px; }
        .subtitle { text-align: center; color: #888; margin-bottom: 30px; }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .tab {
            flex: 1;
            padding: 14px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            color: #888;
            cursor: pointer;
            text-align: center;
            font-weight: 600;
            transition: all 0.2s;
        }
        .tab.active {
            background: rgba(0,212,255,0.2);
            border-color: #00d4ff;
            color: #00d4ff;
        }
        .tab:hover:not(.active) { background: rgba(255,255,255,0.1); }
        .card {
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .hidden { display: none !important; }
        label { display: block; margin-bottom: 6px; font-weight: 500; color: #b0b0b0; }
        textarea, input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            font-size: 14px;
            background: rgba(0,0,0,0.3);
            color: #fff;
            resize: vertical;
        }
        textarea { height: 100px; }
        textarea:focus, input:focus, select:focus { outline: none; border-color: #00d4ff; }
        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }
        select, input[type="range"] {
            width: 100%;
            padding: 10px;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            font-size: 14px;
            background: rgba(0,0,0,0.3);
            color: #fff;
        }
        .range-value { color: #00d4ff; font-weight: bold; }
        .buttons { display: flex; gap: 12px; margin-top: 20px; }
        button {
            flex: 1;
            padding: 14px 24px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-primary { background: linear-gradient(135deg, #00d4ff 0%, #0099cc 100%); color: #000; }
        .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 20px rgba(0,212,255,0.4); }
        .btn-secondary { background: rgba(255,255,255,0.1); color: #fff; border: 1px solid rgba(255,255,255,0.2); }
        .btn-danger { background: #ff4757; color: #fff; }
        .btn-success { background: #2ed573; color: #000; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .status { margin-top: 16px; padding: 12px; border-radius: 8px; background: rgba(0,0,0,0.3); }
        .status-indicator { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
        .status-dot { width: 12px; height: 12px; border-radius: 50%; background: #666; }
        .status-dot.idle { background: #666; }
        .status-dot.connecting { background: #ffa502; animation: pulse 1s infinite; }
        .status-dot.streaming { background: #2ed573; animation: pulse 0.5s infinite; }
        .status-dot.complete { background: #00d4ff; }
        .status-dot.error { background: #ff4757; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; font-size: 13px; color: #888; }
        .stat-value { font-weight: bold; color: #00d4ff; }
        .log { max-height: 120px; overflow-y: auto; font-family: monospace; font-size: 12px; padding: 10px; background: rgba(0,0,0,0.4); border-radius: 6px; margin-top: 10px; }
        .log-entry { margin: 2px 0; color: #888; }
        .log-entry.info { color: #00d4ff; }
        .log-entry.success { color: #2ed573; }
        .log-entry.error { color: #ff4757; }
        .visualizer { height: 50px; background: rgba(0,0,0,0.3); border-radius: 8px; margin-top: 12px; display: flex; align-items: center; justify-content: center; gap: 3px; padding: 0 20px; }
        .bar { width: 4px; background: linear-gradient(to top, #00d4ff, #0099cc); border-radius: 2px; transition: height 0.1s; }
        .voice-list { max-height: 200px; overflow-y: auto; }
        .voice-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 8px; margin-bottom: 8px; }
        .voice-item:hover { background: rgba(0,212,255,0.1); }
        .voice-name { font-weight: 600; color: #00d4ff; }
        .voice-info { font-size: 12px; color: #888; }
        .voice-actions { display: flex; gap: 8px; }
        .voice-actions button { flex: none; padding: 6px 12px; font-size: 12px; }
        .preview-player { margin-top: 16px; padding: 16px; background: rgba(0,212,255,0.1); border-radius: 8px; border: 1px solid rgba(0,212,255,0.3); }
        .help-text { font-size: 12px; color: #888; margin-top: 8px; }
    </style>
</head>
<body>
    <h1>üéôÔ∏è Qwen TTS Lab</h1>
    <p class="subtitle">Text-zu-Sprache mit Voice Design</p>
    
    <div class="tabs">
        <div class="tab active" onclick="switchTab('tts')">üì° TTS</div>
        <div class="tab" onclick="switchTab('voicedesign')">üé® Design</div>
        <div class="tab" onclick="switchTab('voicecloning')">üé§ Cloning</div>
        <div class="tab" onclick="switchTab('myvoices')">üìÇ Stimmen</div>
    </div>

    <!-- Standard TTS Tab -->
    <div id="tab-tts" class="tab-content">
        <div class="card">
            <h2>Text-zu-Sprache</h2>
            <label>Text zum Vorlesen:</label>
            <textarea id="text" placeholder="Gib hier den Text ein...">Hallo! Dies ist ein Test der Qwen Sprachsynthese. Die Stimme klingt sehr nat√ºrlich.</textarea>
            
            <div class="options-grid">
                <div>
                    <label>Modell:</label>
                    <select id="model">
                        <option value="qwen3-tts-flash-realtime">qwen3-tts-flash-realtime</option>
                        <option value="qwen3-tts-realtime">qwen3-tts-realtime</option>
                    </select>
                </div>
                <div>
                    <label>Stimme:</label>
                    <select id="voice">
                        <optgroup label="üåç Internationale Stimmen">
                            <option value="Cherry">Cherry - Sonnig, positiv (W)</option>
                            <option value="Serena">Serena - Sanft (W)</option>
                            <option value="Ethan">Ethan - Hell, warm (M)</option>
                            <option value="Chelsie">Chelsie - Anime-Stil (W)</option>
                            <option value="Momo">Momo - Verspielt (W)</option>
                            <option value="Vivian">Vivian - Cool (W)</option>
                            <option value="Moon">Moon - Spontan (M)</option>
                            <option value="Maia">Maia - Intelligent (W)</option>
                            <option value="Kai">Kai - Beruhigend (M)</option>
                            <option value="Bella">Bella - Zierlich (W)</option>
                            <option value="Bunny">Bunny - S√º√ü (W)</option>
                            <option value="Mia">Mia - Sanft (W)</option>
                        </optgroup>
                        <optgroup label="üé¨ Professionell">
                            <option value="Jennifer">Jennifer - Premium US (W)</option>
                            <option value="Ryan">Ryan - Dramatisch (M)</option>
                            <option value="Katerina">Katerina - Reif (W)</option>
                            <option value="Neil">Neil - Nachrichtensprecher (M)</option>
                            <option value="Elias">Elias - Akademisch (M)</option>
                            <option value="Andre">Andre - Magnetisch (M)</option>
                        </optgroup>
                        <optgroup label="üé≠ Charakterstimmen">
                            <option value="Eldric Sage">Eldric Sage - Weiser Mann (M)</option>
                            <option value="Vincent">Vincent - Rauchig (M)</option>
                            <option value="Ebona">Ebona - Fl√ºster (W)</option>
                            <option value="Seren">Seren - Einschlaf (W)</option>
                            <option value="Pip">Pip - Kindlich (M)</option>
                        </optgroup>
                        <optgroup label="üåê Internationale Akzente">
                            <option value="Lenn">Lenn - Deutsch (M)</option>
                            <option value="Emilien">Emilien - Franz√∂sisch (M)</option>
                            <option value="Bodega">Bodega - Spanisch (M)</option>
                            <option value="Alek">Alek - Russisch (M)</option>
                            <option value="Dolce">Dolce - Italienisch (M)</option>
                            <option value="Sohee">Sohee - Koreanisch (W)</option>
                            <option value="Ono Anna">Ono Anna - Japanisch (W)</option>
                        </optgroup>
                    </select>
                </div>
                <div>
                    <label>Sprache:</label>
                    <select id="language">
                        <option value="Auto">Auto</option>
                        <option value="German">Deutsch</option>
                        <option value="English">English</option>
                        <option value="Chinese">‰∏≠Êñá</option>
                        <option value="Japanese">Êó•Êú¨Ë™û</option>
                        <option value="French">Fran√ßais</option>
                    </select>
                </div>
                <div>
                    <label>Geschwindigkeit: <span class="range-value" id="speedValue">1.0</span></label>
                    <input type="range" id="speed" min="0.5" max="2" step="0.1" value="1" oninput="document.getElementById('speedValue').textContent=this.value">
                </div>
            </div>
            
            <div class="buttons">
                <button class="btn-primary" id="playBtn" onclick="startTTS()">‚ñ∂Ô∏è Abspielen</button>
                <button class="btn-danger" id="stopBtn" onclick="stopTTS()" disabled>‚èπÔ∏è Stoppen</button>
            </div>
        </div>
        
        <div class="card">
            <div class="status-indicator">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">Bereit</span>
            </div>
            <div class="visualizer" id="visualizer"></div>
            <div class="stats">
                <div>Chunks: <span class="stat-value" id="chunkCount">0</span></div>
                <div>Bytes: <span class="stat-value" id="byteCount">0</span></div>
                <div>Zeit: <span class="stat-value" id="timeElapsed">0.0s</span></div>
            </div>
            <div class="log" id="log"></div>
            <div id="downloadSection" class="hidden" style="margin-top:16px;padding:16px;background:rgba(46,213,115,0.1);border-radius:12px;border:1px solid rgba(46,213,115,0.3)">
                <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px">
                    <span style="color:#2ed573">‚úÖ Audio gespeichert!</span>
                    <div style="display:flex;gap:10px">
                        <button id="downloadBtn" onclick="downloadAudio()" class="btn-success" style="padding:8px 16px;border-radius:8px;font-size:14px">‚¨áÔ∏è Download WAV</button>
                        <button class="btn-secondary" onclick="playDownloadedAudio()" style="padding:8px 16px;font-size:14px">üîä Anh√∂ren</button>
                    </div>
                </div>
                <audio id="downloadedAudio" style="width:100%;margin-top:12px;display:none" controls></audio>
            </div>
        </div>
    </div>

    <!-- Voice Design Tab -->
    <div id="tab-voicedesign" class="tab-content hidden">
        <div class="card">
            <h2>üé® Stimme aus Beschreibung erstellen</h2>
            <p class="help-text">Beschreibe die gew√ºnschte Stimme detailliert. Verwende Dimensionen wie Geschlecht, Alter, Tonh√∂he, Sprechgeschwindigkeit, Emotion und Charakteristik.</p>
            
            <label>Stimmen-Beschreibung (Englisch oder Chinesisch):</label>
            <textarea id="voicePrompt" placeholder="z.B.: A warm, friendly young female voice with a medium pitch, slightly fast speaking rate, cheerful and energetic tone. Perfect for podcast hosting or product advertisements.">A calm, professional German male voice, around 35 years old, with a deep pitch, steady speaking rate, and clear articulation. Suitable for audiobook narration or documentary voiceover.</textarea>
            
            <label style="margin-top:16px">Vorschau-Text:</label>
            <textarea id="previewText" style="height:60px" placeholder="Text f√ºr die Audio-Vorschau">Hello everyone, welcome to this demonstration. I hope you enjoy the voice quality.</textarea>
            
            <div class="options-grid">
                <div>
                    <label>Stimmen-Name (optional):</label>
                    <input type="text" id="voiceName" placeholder="z.B. narrator" value="myvoice">
                </div>
                <div>
                    <label>Sprache:</label>
                    <select id="vdLanguage">
                        <option value="en">English</option>
                        <option value="de">Deutsch</option>
                        <option value="zh">‰∏≠Êñá</option>
                        <option value="fr">Fran√ßais</option>
                        <option value="es">Espa√±ol</option>
                        <option value="ja">Êó•Êú¨Ë™û</option>
                        <option value="ko">ÌïúÍµ≠Ïñ¥</option>
                        <option value="ru">–†—É—Å—Å–∫–∏–π</option>
                        <option value="it">Italiano</option>
                        <option value="pt">Portugu√™s</option>
                    </select>
                </div>
            </div>
            
            <div class="buttons">
                <button class="btn-success" id="createVoiceBtn" onclick="createVoice()">‚ú® Stimme erstellen</button>
            </div>
            
            <div id="voicePreview" class="preview-player hidden">
                <h3 style="margin:0 0 10px 0;color:#2ed573">‚úÖ Stimme erstellt!</h3>
                <p>Stimmen-ID: <strong id="createdVoiceName" style="color:#00d4ff"></strong></p>
                <audio id="previewAudio" controls style="width:100%;margin-top:10px"></audio>
                <div class="buttons" style="margin-top:12px">
                    <button class="btn-primary" onclick="useCreatedVoice()">Diese Stimme verwenden ‚Üí</button>
                </div>
            </div>
        </div>
        
        <div class="card">
            <h2>üí° Tipps f√ºr gute Beschreibungen</h2>
            <div style="font-size:13px;color:#aaa">
                <p><strong>‚úÖ Gut:</strong> "A young, lively female voice with a fast speaking rate and noticeably rising intonation, suitable for introducing fashion products."</p>
                <p><strong>‚úÖ Gut:</strong> "A calm middle-aged male voice with a slow speaking rate, deep and magnetic tone, ideal for news reading."</p>
                <p><strong>‚ùå Schlecht:</strong> "Nice-sounding voice" (zu vage)</p>
                <p><strong>‚ùå Schlecht:</strong> "Sounds like [Promi-Name]" (nicht erlaubt)</p>
            </div>
        </div>
    </div>

    <!-- Voice Cloning Tab -->
    <div id="tab-voicecloning" class="tab-content hidden">
        <div class="card">
            <h2>üé§ Stimme aus Audio klonen</h2>
            <p class="help-text">Lade ein Audio-Sample hoch (10-20 Sekunden, klar gesprochen, ohne Hintergrundger√§usche). Die geklonte Stimme wird der Originalstimme sehr √§hnlich sein.</p>
            
            <div style="margin:16px 0;padding:20px;border:2px dashed rgba(0,212,255,0.3);border-radius:12px;text-align:center;background:rgba(0,0,0,0.2)">
                <input type="file" id="audioFile" accept="audio/wav,audio/mp3,audio/mpeg,audio/m4a,audio/mp4" style="display:none" onchange="handleAudioFile(this)">
                <button class="btn-secondary" onclick="document.getElementById('audioFile').click()" style="flex:none">
                    üìÅ Audio-Datei ausw√§hlen
                </button>
                <p id="selectedFileName" style="margin-top:10px;color:#888">Keine Datei ausgew√§hlt</p>
                <audio id="sourceAudio" controls style="width:100%;margin-top:10px;display:none"></audio>
            </div>
            
            <div class="options-grid">
                <div>
                    <label>Stimmen-Name:</label>
                    <input type="text" id="cloneName" placeholder="z.B. meinestimme" value="cloned">
                </div>
                <div>
                    <label>Sprache (optional):</label>
                    <select id="cloneLanguage">
                        <option value="">Auto-Erkennung</option>
                        <option value="de">Deutsch</option>
                        <option value="en">English</option>
                        <option value="zh">‰∏≠Êñá</option>
                        <option value="fr">Fran√ßais</option>
                        <option value="es">Espa√±ol</option>
                        <option value="ja">Êó•Êú¨Ë™û</option>
                        <option value="ko">ÌïúÍµ≠Ïñ¥</option>
                    </select>
                </div>
            </div>
            
            <div class="buttons">
                <button class="btn-success" id="cloneVoiceBtn" onclick="cloneVoice()" disabled>üß¨ Stimme klonen</button>
            </div>
            
            <div id="cloneResult" class="preview-player hidden">
                <h3 style="margin:0 0 10px 0;color:#2ed573">‚úÖ Stimme geklont!</h3>
                <p>Stimmen-ID: <strong id="clonedVoiceName" style="color:#00d4ff"></strong></p>
                <div class="buttons" style="margin-top:12px">
                    <button class="btn-primary" onclick="useClonedVoice()">Diese Stimme verwenden ‚Üí</button>
                </div>
            </div>
        </div>
        
        <div class="card">
            <h2>üìã Audio-Anforderungen</h2>
            <div style="font-size:13px;color:#aaa">
                <ul style="margin:0;padding-left:20px">
                    <li><strong>Dauer:</strong> 10-20 Sekunden (max 60 Sek)</li>
                    <li><strong>Format:</strong> WAV, MP3, M4A</li>
                    <li><strong>Qualit√§t:</strong> Min. 24 kHz, Mono</li>
                    <li><strong>Inhalt:</strong> Klare Sprache, keine Musik/Ger√§usche</li>
                    <li><strong>Gr√∂√üe:</strong> Max 10 MB</li>
                </ul>
                <p style="margin-top:10px"><strong>üí° Tipp:</strong> Nimm in einem ruhigen Raum auf, halte 10cm Abstand zum Mikrofon.</p>
            </div>
        </div>
    </div>

    <!-- My Voices Tab -->
    <div id="tab-myvoices" class="tab-content hidden">
        <div class="card">
            <h2>üìÇ Meine erstellten Stimmen</h2>
            <button class="btn-secondary" onclick="loadVoices()" style="margin-bottom:16px">üîÑ Aktualisieren</button>
            <div id="voiceListContainer" class="voice-list">
                <p style="color:#888">Klicke auf "Aktualisieren" um deine Stimmen zu laden...</p>
            </div>
        </div>
        
        <div id="vdTtsCard" class="card hidden">
            <h2>üé§ Mit Custom Voice sprechen</h2>
            <div style="display:flex;gap:20px;margin-bottom:12px">
                <label>Stimme: <strong id="selectedVoiceName" style="color:#00d4ff"></strong></label>
                <label>Typ: <span id="voiceTypeLabel" style="color:#2ed573"></span></label>
            </div>
            
            <label>Text:</label>
            <textarea id="vdText" placeholder="Text zum Vorlesen...">Dies ist ein Test mit meiner benutzerdefinierten Stimme.</textarea>
            
            <div class="buttons">
                <button class="btn-primary" id="vdPlayBtn" onclick="startVDTTS()">‚ñ∂Ô∏è Abspielen</button>
            </div>
            <div id="vdStatus" style="margin-top:12px;display:none">
                <span id="vdStatusText" style="color:#888">Wird abgespielt...</span>
            </div>
            <div id="vdDownloadSection" class="hidden" style="margin-top:16px;padding:16px;background:rgba(46,213,115,0.1);border-radius:12px;border:1px solid rgba(46,213,115,0.3)">
                <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px">
                    <span style="color:#2ed573">‚úÖ Audio gespeichert!</span>
                    <div style="display:flex;gap:10px">
                        <button id="vdDownloadBtn" onclick="downloadVDAudio()" class="btn-success" style="padding:8px 16px;border-radius:8px;font-size:14px">‚¨áÔ∏è Download WAV</button>
                        <button class="btn-secondary" onclick="playVDDownloadedAudio()" style="padding:8px 16px;font-size:14px">üîä Anh√∂ren</button>
                    </div>
                </div>
                <audio id="vdDownloadedAudio" style="width:100%;margin-top:12px;display:none" controls></audio>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:9999';
        let audioContext = null;
        let isPlaying = false;
        let scheduledTime = 0;
        let chunkCount = 0;
        let totalBytes = 0;
        let startTime = null;
        let timerInterval = null;
        let currentCreatedVoice = null;
        let selectedCustomVoice = null;
        let selectedVoiceType = null; // 'vd' = Voice Design, 'vc' = Voice Cloning
        let vdAbortController = null;
        let vdIsPlaying = false;
        let vdScheduledSources = [];
        
        const SAMPLE_RATE = 24000;
        
        // Visualizer
        const visualizer = document.getElementById('visualizer');
        for (let i = 0; i < 35; i++) {
            const bar = document.createElement('div');
            bar.className = 'bar';
            bar.style.height = '4px';
            visualizer.appendChild(bar);
        }
        const bars = visualizer.querySelectorAll('.bar');
        
        let audioFileBase64 = null;
        let audioFileMimeType = null;
        let currentClonedVoice = null;
        
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach((t, i) => {
                t.classList.toggle('active', ['tts','voicedesign','voicecloning','myvoices'][i] === tab);
            });
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            document.getElementById('tab-' + tab).classList.remove('hidden');
        }
        
        function setStatus(status, text) {
            document.getElementById('statusDot').className = 'status-dot ' + status;
            document.getElementById('statusText').textContent = text;
        }
        
        function log(msg, type='') {
            const logEl = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = 'log-entry ' + type;
            entry.textContent = '[' + new Date().toLocaleTimeString() + '] ' + msg;
            logEl.appendChild(entry);
            logEl.scrollTop = logEl.scrollHeight;
        }
        
        function updateStats() {
            document.getElementById('chunkCount').textContent = chunkCount;
            document.getElementById('byteCount').textContent = (totalBytes/1024).toFixed(1) + ' KB';
            if (startTime) {
                document.getElementById('timeElapsed').textContent = ((Date.now()-startTime)/1000).toFixed(1) + 's';
            }
        }
        
        function animateBars(active) {
            bars.forEach(bar => {
                bar.style.height = active ? (Math.random()*40+5)+'px' : '4px';
            });
        }
        
        async function startTTS() {
            const text = document.getElementById('text').value.trim();
            if (!text) return alert('Bitte Text eingeben!');
            
            chunkCount = 0; totalBytes = 0; startTime = Date.now(); scheduledTime = 0;
            document.getElementById('log').innerHTML = '';
            hideDownloadSection();
            timerInterval = setInterval(updateStats, 100);
            
            if (!audioContext) audioContext = new (window.AudioContext||window.webkitAudioContext)({sampleRate:SAMPLE_RATE});
            if (audioContext.state==='suspended') await audioContext.resume();
            isPlaying = true;
            scheduledTime = audioContext.currentTime;
            
            setStatus('connecting','Verbinde...');
            log('Starte Stream...','info');
            
            document.getElementById('playBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            
            const animInterval = setInterval(() => { if(isPlaying) animateBars(true); }, 100);
            
            try {
                const response = await fetch(API_BASE+'/tts_stream', {
                    method: 'POST',
                    headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({
                        text: text,
                        model: document.getElementById('model').value,
                        voice: document.getElementById('voice').value,
                        language_type: document.getElementById('language').value,
                        speech_rate: parseFloat(document.getElementById('speed').value)
                    })
                });
                
                setStatus('streaming','Streaming...');
                log('Audio empfangen...','success');
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                
                while (true) {
                    const {done, value} = await reader.read();
                    if (done || !isPlaying) break;
                    
                    buffer += decoder.decode(value, {stream:true});
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || '';
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));
                                if (data.error) { log('Fehler: '+data.error,'error'); continue; }
                                if (data.audio) {
                                    chunkCount++;
                                    const pcm = base64ToArrayBuffer(data.audio);
                                    totalBytes += pcm.byteLength;
                                    updateStats();
                                    playPCMChunk(pcm);
                                }
                                if (data.is_end) {
                                    log('Stream beendet. '+(data.usage_characters||0)+' Zeichen','success');
                                    if (data.url) {
                                        showDownloadSection(data.url);
                                    }
                                }
                            } catch(e) {}
                        }
                    }
                }
                setStatus('complete','Fertig');
            } catch(e) {
                setStatus('error','Fehler');
                log('Fehler: '+e.message,'error');
            } finally {
                isPlaying = false;
                clearInterval(animInterval);
                clearInterval(timerInterval);
                animateBars(false);
                document.getElementById('playBtn').disabled = false;
                document.getElementById('stopBtn').disabled = true;
            }
        }
        
        function stopTTS() {
            isPlaying = false;
            setStatus('idle','Gestoppt');
            animateBars(false);
            document.getElementById('playBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
        }
        
        let currentDownloadUrl = null;
        let currentVDDownloadUrl = null;
        
        function showDownloadSection(url) {
            const section = document.getElementById('downloadSection');
            const audio = document.getElementById('downloadedAudio');
            
            currentDownloadUrl = url;
            audio.src = url;
            section.classList.remove('hidden');
            log('Download verf√ºgbar', 'success');
        }
        
        async function downloadAudio() {
            if (!currentDownloadUrl) return;
            try {
                const response = await fetch(currentDownloadUrl);
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'tts_audio_' + Date.now() + '.wav';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            } catch(e) {
                alert('Download fehlgeschlagen: ' + e.message);
            }
        }
        
        function playDownloadedAudio() {
            const audio = document.getElementById('downloadedAudio');
            audio.style.display = 'block';
            audio.play();
        }
        
        function hideDownloadSection() {
            document.getElementById('downloadSection').classList.add('hidden');
            document.getElementById('downloadedAudio').style.display = 'none';
        }
        
        function showVDDownloadSection(url) {
            const section = document.getElementById('vdDownloadSection');
            const audio = document.getElementById('vdDownloadedAudio');
            
            currentVDDownloadUrl = url;
            audio.src = url;
            section.classList.remove('hidden');
        }
        
        async function downloadVDAudio() {
            if (!currentVDDownloadUrl) return;
            try {
                const response = await fetch(currentVDDownloadUrl);
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'custom_voice_' + Date.now() + '.wav';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            } catch(e) {
                alert('Download fehlgeschlagen: ' + e.message);
            }
        }
        
        function playVDDownloadedAudio() {
            const audio = document.getElementById('vdDownloadedAudio');
            audio.style.display = 'block';
            audio.play();
        }
        
        function hideVDDownloadSection() {
            const section = document.getElementById('vdDownloadSection');
            if (section) {
                section.classList.add('hidden');
                document.getElementById('vdDownloadedAudio').style.display = 'none';
            }
        }
        
        function base64ToArrayBuffer(b64) {
            const bin = atob(b64);
            const bytes = new Uint8Array(bin.length);
            for (let i=0; i<bin.length; i++) bytes[i] = bin.charCodeAt(i);
            return bytes.buffer;
        }
        
        function playPCMChunk(pcm) {
            const int16 = new Int16Array(pcm);
            const float32 = new Float32Array(int16.length);
            for (let i=0; i<int16.length; i++) float32[i] = int16[i]/32768.0;
            
            const buf = audioContext.createBuffer(1, float32.length, SAMPLE_RATE);
            buf.getChannelData(0).set(float32);
            
            const src = audioContext.createBufferSource();
            src.buffer = buf;
            src.connect(audioContext.destination);
            
            const now = audioContext.currentTime;
            if (scheduledTime < now) scheduledTime = now;
            src.start(scheduledTime);
            scheduledTime += buf.duration;
        }
        
        // Voice Design
        async function createVoice() {
            const btn = document.getElementById('createVoiceBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Erstelle...';
            
            try {
                const response = await fetch(API_BASE+'/voice_design/create', {
                    method: 'POST',
                    headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({
                        voice_prompt: document.getElementById('voicePrompt').value,
                        preview_text: document.getElementById('previewText').value,
                        preferred_name: document.getElementById('voiceName').value || 'custom',
                        language: document.getElementById('vdLanguage').value
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentCreatedVoice = data.voice;
                    document.getElementById('createdVoiceName').textContent = data.voice;
                    
                    // Play preview
                    const audioData = atob(data.preview_audio);
                    const audioBytes = new Uint8Array(audioData.length);
                    for (let i=0; i<audioData.length; i++) audioBytes[i] = audioData.charCodeAt(i);
                    const blob = new Blob([audioBytes], {type:'audio/wav'});
                    document.getElementById('previewAudio').src = URL.createObjectURL(blob);
                    
                    document.getElementById('voicePreview').classList.remove('hidden');
                } else {
                    alert('Fehler: ' + (data.detail || 'Unbekannter Fehler'));
                }
            } catch(e) {
                alert('Fehler: ' + e.message);
            } finally {
                btn.disabled = false;
                btn.textContent = '‚ú® Stimme erstellen';
            }
        }
        
        function useCreatedVoice() {
            if (currentCreatedVoice) {
                selectedCustomVoice = currentCreatedVoice;
                selectedVoiceType = 'vd'; // Voice Design
                switchTab('myvoices');
                document.getElementById('selectedVoiceName').textContent = currentCreatedVoice;
                document.getElementById('voiceTypeLabel').textContent = 'üé® Voice Design';
                document.getElementById('vdTtsCard').classList.remove('hidden');
            }
        }
        
        // Voice Cloning
        function handleAudioFile(input) {
            const file = input.files[0];
            if (!file) return;
            
            document.getElementById('selectedFileName').textContent = file.name + ' (' + (file.size/1024/1024).toFixed(2) + ' MB)';
            
            // Preview
            const audio = document.getElementById('sourceAudio');
            audio.src = URL.createObjectURL(file);
            audio.style.display = 'block';
            
            // Determine MIME type
            const ext = file.name.split('.').pop().toLowerCase();
            const mimeTypes = {
                'wav': 'audio/wav',
                'mp3': 'audio/mpeg',
                'm4a': 'audio/mp4'
            };
            audioFileMimeType = mimeTypes[ext] || 'audio/wav';
            
            // Read as Base64
            const reader = new FileReader();
            reader.onload = function(e) {
                // Remove data URL prefix
                const base64 = e.target.result.split(',')[1];
                audioFileBase64 = base64;
                document.getElementById('cloneVoiceBtn').disabled = false;
            };
            reader.readAsDataURL(file);
        }
        
        async function cloneVoice() {
            if (!audioFileBase64) {
                alert('Bitte w√§hle zuerst eine Audio-Datei aus!');
                return;
            }
            
            const btn = document.getElementById('cloneVoiceBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Klone Stimme...';
            
            try {
                const lang = document.getElementById('cloneLanguage').value;
                const body = {
                    audio_base64: audioFileBase64,
                    audio_mime_type: audioFileMimeType,
                    preferred_name: document.getElementById('cloneName').value || 'cloned'
                };
                if (lang) body.language = lang;
                
                const response = await fetch(API_BASE+'/voice_cloning/create', {
                    method: 'POST',
                    headers: {'Content-Type':'application/json'},
                    body: JSON.stringify(body)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentClonedVoice = data.voice;
                    document.getElementById('clonedVoiceName').textContent = data.voice;
                    document.getElementById('cloneResult').classList.remove('hidden');
                } else {
                    alert('Fehler: ' + (data.detail || JSON.stringify(data)));
                }
            } catch(e) {
                alert('Fehler: ' + e.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'üß¨ Stimme klonen';
            }
        }
        
        function useClonedVoice() {
            if (currentClonedVoice) {
                selectedCustomVoice = currentClonedVoice;
                selectedVoiceType = 'vc'; // Voice Cloning
                switchTab('myvoices');
                document.getElementById('selectedVoiceName').textContent = currentClonedVoice;
                document.getElementById('voiceTypeLabel').textContent = 'üé§ Voice Cloning';
                document.getElementById('vdTtsCard').classList.remove('hidden');
            }
        }
        
        async function loadVoices() {
            const container = document.getElementById('voiceListContainer');
            container.innerHTML = '<p style="color:#888">Lade...</p>';
            
            try {
                // Beide Listen parallel laden
                const [vdResponse, vcResponse] = await Promise.all([
                    fetch(API_BASE+'/voice_design/list'),
                    fetch(API_BASE+'/voice_cloning/list')
                ]);
                const vdData = await vdResponse.json();
                const vcData = await vcResponse.json();
                
                container.innerHTML = '';
                let hasVoices = false;
                
                // Voice Design Stimmen
                if (vdData.success && vdData.voices && vdData.voices.length > 0) {
                    hasVoices = true;
                    const header = document.createElement('h4');
                    header.style.cssText = 'color:#00d4ff;margin:0 0 10px 0';
                    header.textContent = 'üé® Voice Design';
                    container.appendChild(header);
                    
                    vdData.voices.forEach(v => {
                        const div = document.createElement('div');
                        div.className = 'voice-item';
                        div.innerHTML = `
                            <div>
                                <div class="voice-name">${v.voice}</div>
                                <div class="voice-info">${v.language || 'auto'} ‚Ä¢ ${v.gmt_create}</div>
                            </div>
                            <div class="voice-actions">
                                <button class="btn-primary" onclick="selectVoice('${v.voice}', 'vd')">Verwenden</button>
                                <button class="btn-danger" onclick="deleteVoice('${v.voice}', 'vd')">üóëÔ∏è</button>
                            </div>
                        `;
                        container.appendChild(div);
                    });
                }
                
                // Voice Cloning Stimmen
                if (vcData.success && vcData.voices && vcData.voices.length > 0) {
                    hasVoices = true;
                    const header = document.createElement('h4');
                    header.style.cssText = 'color:#2ed573;margin:20px 0 10px 0';
                    header.textContent = 'üé§ Voice Cloning';
                    container.appendChild(header);
                    
                    vcData.voices.forEach(v => {
                        const div = document.createElement('div');
                        div.className = 'voice-item';
                        div.innerHTML = `
                            <div>
                                <div class="voice-name">${v.voice}</div>
                                <div class="voice-info">${v.target_model || 'vc'} ‚Ä¢ ${v.gmt_create}</div>
                            </div>
                            <div class="voice-actions">
                                <button class="btn-primary" onclick="selectVoice('${v.voice}', 'vc')">Verwenden</button>
                                <button class="btn-danger" onclick="deleteVoice('${v.voice}', 'vc')">üóëÔ∏è</button>
                            </div>
                        `;
                        container.appendChild(div);
                    });
                }
                
                if (!hasVoices) {
                    container.innerHTML = '<p style="color:#888">Keine Stimmen gefunden. Erstelle eine im "Design" oder "Cloning" Tab!</p>';
                }
            } catch(e) {
                container.innerHTML = '<p style="color:#ff4757">Fehler: '+e.message+'</p>';
            }
        }
        
        function selectVoice(voice, type) {
            selectedCustomVoice = voice;
            selectedVoiceType = type || 'vd';
            document.getElementById('selectedVoiceName').textContent = voice;
            document.getElementById('voiceTypeLabel').textContent = type === 'vc' ? 'üé§ Voice Cloning' : 'üé® Voice Design';
            document.getElementById('vdTtsCard').classList.remove('hidden');
        }
        
        async function deleteVoice(voice, type) {
            if (!confirm('Stimme "'+voice+'" wirklich l√∂schen?')) return;
            const endpoint = type === 'vc' ? '/voice_cloning/' : '/voice_design/';
            try {
                await fetch(API_BASE + endpoint + voice, {method:'DELETE'});
                loadVoices();
            } catch(e) {
                alert('Fehler: '+e.message);
            }
        }
        
        function stopVDTTS() {
            // Abort laufenden Request
            if (vdAbortController) {
                vdAbortController.abort();
                vdAbortController = null;
            }
            // Stoppe alle geplanten Audio-Quellen
            vdScheduledSources.forEach(src => {
                try { src.stop(); } catch(e) {}
            });
            vdScheduledSources = [];
            vdIsPlaying = false;
        }
        
        async function startVDTTS() {
            // Stoppe vorherige Wiedergabe falls aktiv
            stopVDTTS();
            
            // Pr√ºfe ob Stimme ausgew√§hlt
            if (!selectedCustomVoice) return alert('Keine Stimme ausgew√§hlt!');
            const text = document.getElementById('vdText').value.trim();
            if (!text) return alert('Bitte Text eingeben!');
            
            // Hole aktuelle Werte (wichtig: bei jedem Klick neu lesen!)
            const voiceToUse = selectedCustomVoice;
            const typeToUse = selectedVoiceType;
            
            const btn = document.getElementById('vdPlayBtn');
            const statusEl = document.getElementById('vdStatus');
            const statusText = document.getElementById('vdStatusText');
            
            btn.textContent = '‚èπÔ∏è Stoppen';
            btn.onclick = function() { stopVDTTS(); btn.textContent = '‚ñ∂Ô∏è Abspielen'; btn.onclick = startVDTTS; statusText.textContent = 'Gestoppt'; };
            statusEl.style.display = 'block';
            statusText.textContent = 'Verbinde mit ' + voiceToUse + '...';
            hideVDDownloadSection();
            
            if (!audioContext) audioContext = new (window.AudioContext||window.webkitAudioContext)({sampleRate:SAMPLE_RATE});
            if (audioContext.state==='suspended') await audioContext.resume();
            scheduledTime = audioContext.currentTime;
            
            vdAbortController = new AbortController();
            vdIsPlaying = true;
            
            // W√§hle den richtigen Endpunkt basierend auf dem Stimmentyp
            const endpoint = typeToUse === 'vc' ? '/tts_vc_stream' : '/tts_vd_stream';
            
            try {
                statusText.textContent = 'Streaming ' + voiceToUse + ' (' + (typeToUse === 'vc' ? 'Cloning' : 'Design') + ')...';
                
                const response = await fetch(API_BASE + endpoint, {
                    method: 'POST',
                    headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({
                        text: text,
                        voice: voiceToUse  // Verwende die lokale Variable!
                    }),
                    signal: vdAbortController.signal
                });
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                let chunkNum = 0;
                
                while (vdIsPlaying) {
                    const {done, value} = await reader.read();
                    if (done) break;
                    
                    buffer += decoder.decode(value, {stream:true});
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || '';
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));
                                if (data.audio && vdIsPlaying) {
                                    chunkNum++;
                                    statusText.textContent = 'Chunk ' + chunkNum + ' (' + voiceToUse + ')';
                                    playVDPCMChunk(base64ToArrayBuffer(data.audio));
                                }
                                if (data.is_end) {
                                    statusText.textContent = 'Fertig! (' + chunkNum + ' chunks)';
                                    if (data.url) {
                                        showVDDownloadSection(data.url);
                                    }
                                }
                            } catch(e) {}
                        }
                    }
                }
            } catch(e) {
                if (e.name !== 'AbortError') {
                    statusText.textContent = 'Fehler: ' + e.message;
                }
            } finally {
                vdIsPlaying = false;
                btn.textContent = '‚ñ∂Ô∏è Abspielen';
                btn.onclick = startVDTTS;
            }
        }
        
        function playVDPCMChunk(pcm) {
            const int16 = new Int16Array(pcm);
            const float32 = new Float32Array(int16.length);
            for (let i=0; i<int16.length; i++) float32[i] = int16[i]/32768.0;
            
            const buf = audioContext.createBuffer(1, float32.length, SAMPLE_RATE);
            buf.getChannelData(0).set(float32);
            
            const src = audioContext.createBufferSource();
            src.buffer = buf;
            src.connect(audioContext.destination);
            
            const now = audioContext.currentTime;
            if (scheduledTime < now) scheduledTime = now;
            src.start(scheduledTime);
            scheduledTime += buf.duration;
            
            // Track source for stopping
            vdScheduledSources.push(src);
            src.onended = () => {
                const idx = vdScheduledSources.indexOf(src);
                if (idx > -1) vdScheduledSources.splice(idx, 1);
            };
        }
        
        setStatus('idle','Bereit');
    </script>
</body>
</html>
